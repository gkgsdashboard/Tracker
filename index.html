<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Tracker (Fast Click)</title>
    <style>
        :root {
            --primary: #4a90e2;
            --work: #f39c12;
            --sleep: #3498db;
            --success: #2ecc71;
            --danger: #e74c3c;
            --bg: #f4f7f6;
            --text: #333;
            --border: #ddd;
            --today-highlight: #fffae6;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            width: 98%; 
            max-width: 100%;
            box-sizing: border-box;
            overflow-x: auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--bg);
            padding-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .controls { display: flex; gap: 5px; }
        
        .controls button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            white-space: nowrap;
        }
        .controls button:hover { opacity: 0.9; }
        .controls button:disabled { background: #ccc; cursor: not-allowed; opacity: 0.7; }

        .btn-download { background-color: #27ae60 !important; }
        .btn-restore { background-color: #e67e22 !important; }

        .chart-container {
            margin-top: 20px;
            padding: 15px;
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 8px;
        }
        canvas { width: 100%; height: 200px; display: block; }
        
        .legend { display: flex; gap: 20px; justify-content: center; font-size: 0.85rem; margin-bottom: 10px; }
        .dot { width: 10px; height: 10px; display: inline-block; border-radius: 50%; margin-right: 5px; }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid var(--border); padding: 6px 4px; text-align: center; vertical-align: middle; font-size: 0.95rem; }
        th { background-color: #f8f9fa; font-weight: 600; color: #444; }

        input[type="number"] { width: 100%; max-width: 50px; text-align: center; border: 1px solid #ccc; padding: 5px; border-radius: 4px; }
        
        /* BUTTON STYLES */
        .habit-btn {
            width: 30px; height: 30px; border-radius: 6px; border: 1px solid #ccc; background: white;
            cursor: pointer; font-size: 1.1rem; line-height: 1; display: flex; align-items: center; justify-content: center; margin: 0 auto;
            transition: background-color 0.1s;
        }
        .habit-btn.done { background-color: var(--success) !important; border-color: var(--success) !important; color: white !important; }
        .habit-btn.skipped { background-color: var(--danger) !important; border-color: var(--danger) !important; color: white !important; }

        tr.today { 
            background-color: var(--today-highlight) !important; 
            border: 2px solid var(--primary);
            font-weight: bold;
        }
        tr.weekend { background-color: #fafafa; }

        @media (max-width: 600px) {
            th, td { font-size: 0.8rem; padding: 4px 2px; }
            .habit-btn { width: 24px; height: 24px; font-size: 0.9rem; }
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <div>
                <h1 id="monthYearDisplay" style="margin: 0; font-size: 1.4rem;">Month Year</h1>
                <p style="font-size: 12px; color: #666; margin: 2px 0 0 0;">Dec 2025 - July 2026</p>
            </div>
            
            <div style="text-align: right; display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end;">
                <div class="controls">
                    <button id="prevBtn" onclick="changeMonth(-1)">&#8592; Prev</button>
                    <button onclick="scrollToToday()" style="background-color: #666;">üìç Today</button>
                    <button id="nextBtn" onclick="changeMonth(1)">Next &#8594;</button>
                </div>
                <div class="controls">
                    <button onclick="downloadBackup()" class="btn-download">üíæ Save</button>
                    <button onclick="document.getElementById('fileInput').click()" class="btn-restore">üìÇ Load</button>
                    <input type="file" id="fileInput" style="display: none;" onchange="loadBackup(this)">
                </div>
            </div>
        </header>

        <div class="chart-container">
            <div class="legend">
                <span><span class="dot" style="background: var(--sleep);"></span>Sleep</span>
                <span><span class="dot" style="background: var(--work);"></span>Work</span>
            </div>
            <canvas id="trackerChart"></canvas>
        </div>

        <table>
            <thead>
                <tr>
                    <th style="width: 40px;">Date</th>
                    <th style="width: 50px;">Day</th>
                    <th style="background-color: #e3f2fd; width: 80px;">Sleep</th>
                    <th style="background-color: #fff3e0; width: 80px;">Work</th>
                    <th>Math</th>
                    <th>Reasoning</th>
                    <th>English</th>
                    <th>GK/GS</th>
                </tr>
            </thead>
            <tbody id="trackerBody"></tbody>
        </table>
    </div>

    <script>
        const START_YEAR = 2025;
        const START_MONTH = 11; // Dec
        const END_YEAR = 2026;
        const END_MONTH = 6;    // July

        let initDate = new Date();
        const minDate = new Date(START_YEAR, START_MONTH, 1);
        const maxDate = new Date(END_YEAR, END_MONTH, 1);

        if (initDate < minDate) initDate = minDate;
        else if (initDate > maxDate) initDate = maxDate;
        
        let currentDate = new Date(initDate);

        const trackerBody = document.getElementById('trackerBody');
        const monthYearDisplay = document.getElementById('monthYearDisplay');
        const canvas = document.getElementById('trackerChart');
        const ctx = canvas.getContext('2d');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');

        // --- CORE FUNCTIONS ---
        function getStorageKey(dateStr) { return `tracker_${dateStr}`; }

        // FIXED: Helper to save quietly
        function saveToStorage(dateStr, field, value) {
            let data = JSON.parse(localStorage.getItem(getStorageKey(dateStr))) || {};
            data[field] = value;
            localStorage.setItem(getStorageKey(dateStr), JSON.stringify(data));
        }

        function saveData(dateStr, field, value) {
            saveToStorage(dateStr, field, value);
            setTimeout(drawChart, 10); // Draw chart slightly later to not block UI
        }

        // FIXED: UI Updates FIRST, then saves
        function cycleHabit(btn, dateStr, habitKey) {
            let currentState = btn.getAttribute('data-status');
            let newState;
            
            if (!currentState || currentState === 'null') newState = 'done';
            else if (currentState === 'done') newState = 'skipped';
            else newState = null;

            // 1. Update Visuals IMMEDIATELY
            updateButtonVisuals(btn, newState);

            // 2. Save Data asynchronously
            setTimeout(() => {
                saveToStorage(dateStr, habitKey, newState);
            }, 0);
        }

        function updateButtonVisuals(btn, state) {
            btn.setAttribute('data-status', state || 'null');
            // Force remove classes
            btn.className = 'habit-btn'; 
            
            if (state === 'done' || state === true) { 
                btn.classList.add('done'); 
                btn.innerHTML = '&#10003;'; 
            } else if (state === 'skipped') {
                btn.classList.add('skipped'); 
                btn.innerHTML = '&#10005;'; 
            } else { 
                btn.innerHTML = ''; 
            }
        }

        // --- BACKUP ---
        function downloadBackup() {
            const data = JSON.stringify(localStorage);
            const blob = new Blob([data], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url;
            a.download = "study_tracker_backup_" + new Date().toISOString().split('T')[0] + ".json";
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

        function loadBackup(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    localStorage.clear();
                    Object.keys(data).forEach(k => localStorage.setItem(k, data[k]));
                    alert("Data Restored!");
                    location.reload();
                } catch (err) { alert("Invalid backup file."); }
            };
            reader.readAsText(file);
        }

        function changeMonth(offset) {
            const newDate = new Date(currentDate);
            newDate.setMonth(newDate.getMonth() + offset);
            if (newDate < new Date(START_YEAR, START_MONTH, 1) || 
                newDate > new Date(END_YEAR, END_MONTH, 1)) return;
            currentDate = newDate;
            renderCalendar();
        }

        function updateNavButtons() {
            const cY = currentDate.getFullYear();
            const cM = currentDate.getMonth();
            prevBtn.disabled = (cY === START_YEAR && cM === START_MONTH);
            nextBtn.disabled = (cY === END_YEAR && cM === END_MONTH);
        }

        function renderCalendar() {
            trackerBody.innerHTML = '';
            updateNavButtons();

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            monthYearDisplay.innerText = new Date(year, month).toLocaleString('default', { month: 'long', year: 'numeric' });

            const todayReal = new Date();
            const isCurrentMonth = (todayReal.getFullYear() === year && todayReal.getMonth() === month);

            for (let i = 1; i <= daysInMonth; i++) {
                const dateObj = new Date(year, month, i);
                const dayName = dateObj.toLocaleDateString('en-US', { weekday: 'short' });
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const savedData = JSON.parse(localStorage.getItem(getStorageKey(dateStr))) || {};

                const row = document.createElement('tr');
                if (isCurrentMonth && i === todayReal.getDate()) {
                    row.classList.add('today'); row.id = 'todayRow';
                }
                if (dayName === 'Sat' || dayName === 'Sun') row.classList.add('weekend');

                const h1Btn = createHabitButton(dateStr, 'h1', savedData.h1);
                const h2Btn = createHabitButton(dateStr, 'h2', savedData.h2);
                const h3Btn = createHabitButton(dateStr, 'h3', savedData.h3);
                const h4Btn = createHabitButton(dateStr, 'h4', savedData.h4);

                row.innerHTML = `
                    <td>${i}</td>
                    <td>${dayName}</td>
                    <td><input type="number" min="0" max="24" value="${savedData.sleep || ''}" onchange="saveData('${dateStr}', 'sleep', this.value)"></td>
                    <td><input type="number" min="0" max="24" value="${savedData.work || ''}" onchange="saveData('${dateStr}', 'work', this.value)"></td>
                `;
                
                [h1Btn, h2Btn, h3Btn, h4Btn].forEach(btn => {
                    const td = document.createElement('td'); td.appendChild(btn); row.appendChild(td);
                });
                trackerBody.appendChild(row);
            }
            // Safely draw chart
            try { drawChart(); } catch(e) { console.error(e); }
        }

        function createHabitButton(dateStr, key, savedState) {
            const btn = document.createElement('button');
            btn.className = 'habit-btn';
            updateButtonVisuals(btn, savedState);
            btn.onclick = () => cycleHabit(btn, dateStr, key);
            return btn;
        }

        function scrollToToday() {
            const now = new Date();
            if (now >= minDate && now <= maxDate) {
                if(currentDate.getMonth() !== now.getMonth() || currentDate.getFullYear() !== now.getFullYear()) {
                    currentDate = new Date(now);
                    renderCalendar();
                }
            }
            setTimeout(() => {
                const todayRow = document.getElementById('todayRow');
                if (todayRow) {
                    todayRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    todayRow.style.transition = "background-color 0.5s";
                    todayRow.style.backgroundColor = "#ffeebb";
                    setTimeout(() => { todayRow.style.backgroundColor = ""; }, 1000);
                }
            }, 100);
        }

        function drawChart() {
            if (!canvas.getContext) return;
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);
            ctx.clearRect(0, 0, rect.width, rect.height);

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const padding = 20;
            const chartWidth = rect.width - (padding * 2);
            const chartHeight = rect.height - (padding * 2);
            const xStep = chartWidth / (daysInMonth - 1);
            
            let sleepData = []; let workData = [];
            for (let i = 1; i <= daysInMonth; i++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const data = JSON.parse(localStorage.getItem(getStorageKey(dateStr))) || {};
                sleepData.push(parseFloat(data.sleep) || 0);
                workData.push(parseFloat(data.work) || 0);
            }

            drawLine(sleepData, '#3498db', xStep, padding, chartHeight); 
            drawLine(workData, '#f39c12', xStep, padding, chartHeight);  
            
            ctx.fillStyle = '#999'; ctx.font = '10px sans-serif';
            ctx.fillText('1', padding, rect.height - 5);
            ctx.fillText(daysInMonth, rect.width - padding - 10, rect.height - 5);
        }

        function drawLine(dataPoints, color, xStep, padding, chartHeight) {
            ctx.beginPath(); ctx.strokeStyle = color; ctx.lineWidth = 2;
            dataPoints.forEach((val, index) => {
                const x = padding + (index * xStep);
                const y = (padding + chartHeight) - ((val / 16) * chartHeight); 
                if (index === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                ctx.fillStyle = color; ctx.fillRect(x - 2, y - 2, 4, 4);
            });
            ctx.stroke();
        }

        renderCalendar();
        scrollToToday();
        window.addEventListener('resize', () => { try { drawChart(); } catch(e){} });
    </script>
</body>
</html>